(async()=>{class e{constructor(a){this.chartData=a||[],this.title=t.getString("title",""),this.otherRatio=t.getFloat("otherRatio",.15),this.hideLabel=t.getBoolean("hideLabel",!1),this.transparentBackground=t.getBoolean("transparentBackground",!1),this.scale=1.5,this.offsetX=180,this.offsetY=30,this.holeRadius=60,this.canvasEl=e._injectChart(),this.chart=new Chartist.Pie("#ct-chart",this.chartistData,this.chartistOptions),this.renderedSlicesCount=0,this.renderedLabelsCount=this.hideLabel?this.chartistData.labels.length:0,this.onDraw=null;this.chart.on("draw",async t=>{if("slice"==t.type){const e=this.chartistData.imageSrcs[t.index];if(e){const a=`img-${Math.random().toString(36).substr(2,8)}`,s=[t.startAngle,t.endAngle,90,180,270];let r=Number.MAX_VALUE,l=Number.MAX_VALUE,c=-Number.MAX_VALUE,i=-Number.MAX_VALUE;const o=this.holeRadius/t.radius;for(const e of s){if(e<t.startAngle)continue;if(t.endAngle<e)break;const a=Math.sin(e*(Math.PI/180)),n=-Math.cos(e*(Math.PI/180)),s=a*o,d=n*o;r=Math.min(r,s,a),l=Math.min(l,d,n),c=Math.max(c,s,a),i=Math.max(i,d,n)}const d=(t.startAngle+t.endAngle)/2*(Math.PI/180),m=(t.endAngle-t.startAngle)/2*(Math.PI/180),h=2*(1+o+o*o)*Math.sin(m)/(3*(1+o)*m),u=h*Math.sin(d),p=h*-Math.cos(d),g=Math.max(c-r,i-l)/2*this.scale,b=360*g,y=503*g,v=t.radius*(u-(g-1))+this.offsetX,x=t.radius*(p-(g-1))+this.offsetY,E="http://www.w3.org/2000/svg",f=document.createElementNS(E,"defs"),w=document.createElementNS(E,"pattern");w.setAttribute("id",a),w.setAttribute("patternUnits","userSpaceOnUse"),w.setAttribute("x",`${v}`),w.setAttribute("y",`${x}`),w.setAttribute("width",`${b}`),w.setAttribute("height",`${y}`);const C=document.createElementNS(E,"image");C.setAttribute("href",await n(e)),C.setAttribute("width",`${b}`),C.setAttribute("height",`${y}`),w.appendChild(C),f.appendChild(w),this.chart.svg._node.appendChild(f),t.element._node.setAttribute("style",`fill: url(#${a})`)}else t.element._node.setAttribute("style","fill: #9e9e9e");this.renderedSlicesCount+=1}else if("label"==t.type){const a=t.text.split("\n");t.element._node.textContent="",t.element._node.setAttribute("x",`${t.x}`),t.element._node.setAttribute("y",`${t.y}`),t.element._node.setAttribute("dy",`${1.5-a.length}em`),t.element._node.removeAttribute("dx"),a.forEach(a=>{const n=a.match(/^([0-9]{1,3})((?:\.[0-9]+)?%)$/);n&&3==n.length?(e._drawText(t.element._node,n[1],{x:`${t.x}`,dy:"1.1em",className:"ct-label--border ct-label--strong"}),e._drawText(t.element._node,n[2],{className:"ct-label--border"}),e._drawText(t.element._node,n[1],{x:`${t.x}`,className:"ct-label--strong"}),e._drawText(t.element._node,n[2])):(e._drawText(t.element._node,a,{x:`${t.x}`,dy:"1.1em",className:"ct-label--border"}),e._drawText(t.element._node,a,{x:`${t.x}`}))});const n=t.element._node.firstChild;n instanceof SVGElement&&(n.removeAttribute("x"),n.removeAttribute("dy")),this.renderedLabelsCount+=1}this.onDraw&&this.renderedSlicesCount==this.chartistData.imageSrcs.length&&this.renderedLabelsCount==this.chartistData.labels.length&&await this.onDraw()})}get chartistData(){this.chartData.sort((e,t)=>t.value-e.value);const e=this.chartData.map(e=>e.value).reduce((e,t)=>e+t,0);let t=0,a=0;for(const n of this.chartData){if(1-this.otherRatio<=t/e){a=n.value;break}t+=n.value}const n=this.chartData.filter(e=>e.value>a);if(n.length<this.chartData.length){const t=n.map(e=>e.value).reduce((e,t)=>e+t,0);n.push({label:"その他",value:e-t})}return{labels:n.map(e=>e.label),series:n.map(e=>e.value),imageSrcs:n.map(e=>e.imageSrc)}}get chartistOptions(){return{donut:!0,donutSolid:!0,donutWidth:175-this.holeRadius,chartPadding:20,labelOffset:40,labelDirection:"explode",showLabel:!this.hideLabel,labelInterpolationFnc:(e,t)=>{const a=this.chartistData.series.reduce((e,t)=>e+t,0),n=this.chartistData.series[t]/a*100;return"string"==typeof e?`${e}\n${n.toFixed(1)}%`:`${n.toFixed(1)}%`}}}static _injectChart(){let e=document.querySelector("#ct-canvas");if(e)return e;(e=document.createElement("div")).id="ct-canvas",e.style.width="720px",e.style.position="absolute",e.style.top=0,e.style.opacity=0;const t=document.createElement("div");t.className="ct-container";const a=document.createElement("div");return a.id="ct-chart",a.className="ct-chart",t.append(a),e.append(t),document.body.append(e),e}static _drawText(e,t,a){const n=document.createElementNS("http://www.w3.org/2000/svg","tspan");a&&Object.entries(a).forEach(([e,t])=>{n.setAttribute("className"==e?"class":e,t)}),n.textContent=t,e.append(n)}static _createTitleElement(e){const t=document.createElement("span");return t.style["font-weight"]=700,t.style["font-size"]="1.2rem",t.style.display="block",t.className="Title",t.textContent=e,t}static _createTextInputElement(t,a,n,s){const r=document.createElement("div");r.style.width="calc(100% - 120px)";const l=e._createTitleElement(t),c=document.createElement("label");c.className="KSTextInput";const i=document.createElement("textarea");return i.rows=1,i.value=n,i.placeholder=a,i.className="KSTextInput_text",i.style.height="44px",i.style.padding="10px 6px",i.style["margin-top"]="8px",i.style["margin-bottom"]="8px",i.oninput=(()=>{s&&s(i)}),c.append(i),r.append(l,c),r}static _createSelectElement(t,a,n,s){const r=document.createElement("div");r.style.width="120px";const l=e._createTitleElement(t),c=document.createElement("label");c.className="KSSelect",c.style.width="calc(100% - 2px)",c.style["margin-top"]="8px",c.style["margin-bottom"]="8px";const i=document.createElement("div");i.className="KSSelect_inner";const o=document.createElement("select");return o.title="その他の割合",o.className="KSSelect_text",o.style["border-radius"]="7px",o.onchange=(()=>{s&&s(o)}),a.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,t.value==n&&(t.selected="selected"),o.append(t)}),i.append(o),c.append(i),r.append(l,c),r}static _createCheckBoxElement(e,t,a){const n=document.createElement("label");n.className="KSCheckBox",n.style["margin-right"]="0.5em";const s=document.createElement("input");s.type="checkbox",s.className="KSCheckBoxInput",s.checked=t,s.onchange=(()=>{a&&a(s)});const r=document.createElement("span");r.className="KSCheck";const l=document.createElement("span");return l.className="KSFormText",l.textContent=e,n.append(s,r,l),n}static _createButtonElement(e,t){const a=document.createElement("div");a.className="Layout Layout-center";const n=document.createElement("a");n.className=KS.UA.Tablet||KS.UA.Mobile?"Button Button-texture Button-responsive Button-large noLinkBtn":"Button Button-texture noLinkBtn",n.onclick=(async()=>{t&&await t(n)});const s=document.createElement("span");return s.className="bebel",s.textContent=e,n.append(s),a.append(n),a}injectControlElements(){const t=document.querySelector("div.MainArea > div.ContentsArea > section");let a=t.querySelector("#ct-layout");if(a)return a;(a=document.createElement("div")).id="ct-layout",a.className="Layout";const n=document.createElement("h2");n.className="Heading2",n.textContent="デッキ分布図つくるマシーン";const s=document.createElement("div");s.style.display="flex";const r=e._createTextInputElement("タイトル","大会名など",this.title,e=>{this.title=e.value});r.style["margin-bottom"]="4px",r.style["margin-right"]="0.7em";const l=e._createSelectElement("その他の割合",[{label:"0%",value:0},{label:"5%",value:.05},{label:"10%",value:.1},{label:"15%",value:.15},{label:"20%",value:.2},{label:"25%",value:.25},{label:"30%",value:.3},{label:"35%",value:.35},{label:"40%",value:.4}],this.otherRatio,e=>{this.otherRatio=e.value});l.style["margin-bottom"]="4px",s.append(r,l);const c=e._createCheckBoxElement("ラベルを隠す",this.hideLabel,e=>{this.hideLabel=e.checked}),i=e._createCheckBoxElement("背景を透過する",this.transparentBackground,e=>{this.transparentBackground=e.checked}),o=e._createButtonElement("デッキ分布図をつくる",e=>{this.onPress(e)});return a.append(n,s,c,i,o),t.append(a),a}static _injectInputElements(){const e=t.getObject("cardNames",{});Array.from(document.querySelectorAll("#cardImagesView > div > div > table > tbody")).forEach(t=>{if(t.querySelector('tr:last-child > td > input[type="text"]'))return;const a=t.querySelector("tr.imgBlockArea > td > a > img"),n=parseInt(a.id.replace(/^img_([0-9]+)$/,"$1"),10),s=a.alt.replace(/&amp;/g,"&");a.alt=e.hasOwnProperty(n)?e[n]:s;{const e=t.querySelector("tr > td.cPos.nowrap > *");if(e.style.marginTop=0,e.style.marginBottom=0,e.querySelector("span")){const t=document.createElement("input");t.type="text",t.pattern="^[0-9]+$",t.value=parseInt(e.innerText,10),t.style.width="calc(100% - 56px)",t.style["margin-right"]="4px",t.style.padding="3px 6px",t.style["box-sizing"]="border-box",t.style.border="solid 2px #ddd",t.style["background-color"]="#fff",t.style["border-radius"]="4px",t.oninput=(()=>{t.value=t.value.replace(/[０-９]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace(/[^0-9]/g,"");const a=e.querySelector("a").getAttribute("onclick").replace(/^javascript:PCGDECK.cardCntChange\('(deck_[^']+)', '[0-9]+', -1\); return false;$/,"$1"),s=document.createElement("script");s.append(`\n                  PCGDECK.cardCntSet("${a}", ${n}, ${parseInt(t.value,10)||0})\n                  $("#cardCntImagesArea").text("現在のデッキ内には "+PCGDECK.cardViewCnt+" 枚のカードが選択されています")\n                  $("#cardCntImagesArea").append($("<div />").text("削除したカードは「調整用カード」枠に入ります ").addClass("Text-annotation"));\n                `),document.body.append(s),s.remove()}),e.prepend(t),e.querySelector("span").remove(),e.querySelector("br").remove()}}const r=document.createElement("tr"),l=document.createElement("td");l.setAttribute("colspan",2);const c=document.createElement("input");c.type="text",c.value=e.hasOwnProperty(n)?e[n]:s,c.placeholder=s,c.style.width="100%",c.style.padding="3px 6px",c.style["box-sizing"]="border-box",c.style.border="solid 2px #ddd",c.style["background-color"]="#fff",c.style["border-radius"]="4px",c.oninput=(()=>{const e=document.createElement("script");e.append(`\n              PCGDECK.searchItemNameAlt[${n}] = "${c.value}"\n            `),document.body.append(e),e.remove(),a.alt=c.value}),l.append(c),r.append(l),t.append(r)});const a=document.createElement("script");a.append('\n        PCGDECK.cardCntChange=function(f,e,k){var l=$("#"+f).val();if(l!=""){var h=l.split("-");var i=h.length;var g=[];for(ii=0;ii<i;ii++){var j=h[ii].split("_");if(j[0]==e){j[1]=parseInt(j[1],10)+k;if(j[1]<=0){j[1]=0}g.push(j.join("_"));PCGDECK.errorItemClear(j[0])}else{g.push(h[ii])}}$("#"+f).val(g.join("-"));PCGDECK.cardTableViewCall(1)}return false};\n        PCGDECK.cardCntSet=function(f,e,k){var l=$("#"+f).val();if(l!=""){var h=l.split("-");var i=h.length;var g=[];for(ii=0;ii<i;ii++){var j=h[ii].split("_");if(j[0]==e){m=parseInt(j[1],10);j[1]=k;if(j[1]<=0){j[1]=0}PCGDECK.cardViewCnt+=j[1]-m;g.push(j.join("_"));PCGDECK.errorItemClear(j[0])}else{g.push(h[ii])}}$("#"+f).val(g.join("-"));PCGDECK.setCookieCall(f)}return false};\n      '),document.body.append(a),a.remove()}injectInputElements(){e._injectInputElements(),a("#cardImagesView",()=>{e._injectInputElements()})}draw(e,t){this.chartData=e,this.renderedSlicesCount=0,this.renderedLabelsCount=this.hideLabel?this.chartistData.labels.length:0;const a=document.createElement("div");a.className="ct-title ct-title--border",a.textContent=this.title;const n=document.createElement("div");n.className="ct-title",n.textContent=this.title;const s=document.createElement("span");s.className="ct-twitter";const r=document.createElement("div");r.className="ct-signature",r.append("powered by",s,"@tilanosaur"),this.canvasEl.querySelector(".ct-container").append(a,n,r),this.onDraw=(async()=>{t&&await t(),a.remove(),n.remove(),s.remove(),r.remove()}),this.chart.update(this.chartistData,this.chartistOptions)}async onPress(e){e.classList.add("disabled"),e.classList.add("loading"),t.setItem("title",this.title),t.setItem("otherRatio",this.otherRatio),t.setItem("hideLabel",this.hideLabel),t.setItem("transparentBackground",this.transparentBackground);const a=s(),n=t.getObject("cardNames",{});a.forEach(e=>{n[e.id]=e.name}),t.setItem("cardNames",JSON.stringify(n));const r=a.map(e=>({label:e.name,value:e.count,imageSrc:e.imageSrc}));this.draw(r,async()=>{await this.openAsPNG(),e.classList.remove("disabled"),e.classList.remove("loading")})}async openAsPNG(){const e=(await html2canvas(this.canvasEl,{scale:16/9,backgroundColor:this.transparentBackground?null:"#ffffff",onclone:e=>{e.getElementById(this.canvasEl.id).style.opacity=1}})).toDataURL("image/png"),t=window.open();t?t.document.write(`<img src="${e}" />`):window.alert("デッキ分布図を作成できませんでした。\nWebブラウザの設定から、ポップアップウインドウを許可してください。")}}class t{static getItem(e){return window.localStorage.getItem(`PTCGChart::${e}`)}static getBoolean(e,a){const n=t.getItem(e);return null!=n?"true"===n:a||!1}static getInt(e,a){const n=t.getItem(e);return null!=n?parseInt(n):a||0}static getFloat(e,a){const n=t.getItem(e);return null!=n?parseFloat(n):a||0}static getString(e,a){const n=t.getItem(e);return null!=n?n:a||""}static getObject(e,a){const n=t.getItem(e);return null!=n?JSON.parse(n):a||{}}static setItem(e,t){null!=t&&window.localStorage.setItem(`PTCGChart::${e}`,t)}}const a=(e,t)=>{"undefined"==typeof globalObserver&&(globalObserver=new MutationObserver(async e=>{t&&t()}),globalObserver.observe(document.querySelector(e),{childList:!0}))},n=e=>new Promise((t,a)=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=(()=>{const e=document.createElement("canvas");e.width=n.width,e.height=n.height,e.getContext("2d").drawImage(n,0,0),t(e.toDataURL("image/png"))}),n.onerror=a,n.src=e}),s=()=>Array.from(document.querySelectorAll("#cardImagesView > div > div > table > tbody")).map(e=>{const t=e.querySelector("tr.imgBlockArea > td > a > img"),a=parseInt(t.id.replace(/^img_([0-9]+)$/,"$1"),10),n=e.querySelector("tr > td.cPos.nowrap > *"),s=n.querySelector('input[type="text"]');return{id:a,name:t.alt,imageSrc:t.src,count:parseInt(s&&s.value||n.innerText,10)||0}}).filter(e=>e.count>0),r=e=>new Promise((t,a)=>{const n=document.createElement("link");n.rel="stylesheet",n.onload=(()=>{t()}),n.href=e,document.head.append(n)}),l=e=>new Promise((t,a)=>{const n=document.createElement("script");n.onload=(()=>{t()}),n.src=e,document.head.append(n)});if(!/^https:\/\/www\.pokemon-card\.com\/deck\/(deck.html(\?deckID=[0-9A-Za-z]{6}-[0-9A-Za-z]{6}-[0-9A-Za-z]{6})?|[^.]+.html\/deckID\/[0-9A-Za-z]{6}-[0-9A-Za-z]{6}-[0-9A-Za-z]{6}\/?)$/.test(window.location.href))return void window.alert("デッキ分布図を作成できませんでした。\nデッキ作成ツールを開いて、プログラムを実行してください。");await r("https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css"),await r("https://blachocolat.github.io/ptcg-chart/style.min.css"),await l("https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"),await l("https://cdn.jsdelivr.net/npm/html2canvas/dist/html2canvas.min.js");const c=new e;c.injectControlElements(),c.injectInputElements()})();